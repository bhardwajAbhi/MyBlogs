


    






    






    



    




<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Coding practices that a developer need to follow in order to design and implement robust, rugged, and secure apps for Android device.">
      
      
        <meta name="author" content="Abhishek Bhardwaj (abhishekbhardwaj090@gmail.com)">
      
      
        <link rel="canonical" href="https://bhardwajabhi.github.io/MyBlogs/posts/mobile-security/android-secure-coding-practices/">
      
      
        <link rel="prev" href="../mobile-security-trends-2023/">
      
      
        <link rel="next" href="../../../tags/">
      
      <link rel="icon" href="../../../favicon.png">
      <meta name="generator" content="mkdocs-1.5.1, mkdocs-material-9.1.21">
    
    
    <title>Secure Coding Practices - Abhishek Bhardwaj</title>

    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.eebd395e.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Serif";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/view-bigimg.css">
    
      <link rel="stylesheet" href="../../../assets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
    
    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Secure Coding Practices - Abhishek Bhardwaj" />
    <meta property="og:description" content="Coding practices that a developer need to follow in order to design and implement robust, rugged, and secure apps for Android device. - Tutorials, Blogs, Guides on Android." />
    <meta property="og:url" content="https://bhardwajabhi.github.io/MyBlogs/posts/mobile-security/android-secure-coding-practices/" />
    <meta property="og:image" content="https://bhardwajabhi.github.io/MyBlogs/posts/mobile-security/android-secure-coding-practices/1_secure_coding_banner.png" />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Secure Coding Practices - Abhishek Bhardwaj" />
    <meta name="twitter:description" content="Coding practices that a developer need to follow in order to design and implement robust, rugged, and secure apps for Android device. - Tutorials, Blogs, Guides on Android." />
    <meta name="twitter:image" content="https://bhardwajabhi.github.io/MyBlogs/posts/mobile-security/android-secure-coding-practices/1_secure_coding_banner.png" />

  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="deep-orange">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="">
    <a href="../../.." title="Abhishek Bhardwaj" class="md-header__button md-logo" aria-label="Abhishek Bhardwaj" data-md-component="logo">
      
  <img src="../../../assets/logo.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Abhishek Bhardwaj
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Secure Coding Practices
            
          </span>
        </div>
        
            <style>
                .md-header__nav {
                    float: right;
                }
                .md-header__nav__inner:not([hidden]) {
                    display: flex;
                }
            </style>
            <div class="md-header__nav">
                <nav class="md-header__nav__inner">
                    
                        
                        <a href="../mobile-security-trends-2023/" aria-label="Previous: 2023 Mobile Security Trends" rel="prev">
                            <div class="md-footer__button md-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
                            </div>
                        </a>
                    
                    
                        
                        <a href="../../../tags/" aria-label="Next: Tags" rel="next">
                            <div class="md-footer__button md-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
                            </div>
                        </a>
                    
                </nav>
            </div>
        
    </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../" class="md-tabs__link md-tabs__link--active">
        Posts
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../tags/" class="md-tabs__link">
        Tags
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
    
    

    <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
        <div class="md-sidebar__scrollwrap">
            <div class="md-sidebar__inner">
                

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Abhishek Bhardwaj" class="md-nav__button md-logo" aria-label="Abhishek Bhardwaj" data-md-component="logo">
      
  <img src="../../../assets/logo.jpg" alt="logo">

    </a>
    Abhishek Bhardwaj
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../">Posts</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Posts" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Posts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        Recent posts
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2_2">
          Mobile security
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Mobile security" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Mobile security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2_1" type="checkbox" id="__nav_2_2_1" >
      
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../mobile-security-trends-2023/">Latest Trends in Mobile Security (2023)</a>
          
        </div>
      
      <nav class="md-nav" aria-label="Latest Trends in Mobile Security (2023)" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_2_1">
          <span class="md-nav__icon md-icon"></span>
          Latest Trends in Mobile Security (2023)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mobile-security-trends-2023/" class="md-nav__link">
        2023 Mobile Security Trends
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2_2" type="checkbox" id="__nav_2_2_2" checked>
      
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index md-nav__link--active">
          <a href="./">Secure Coding Practices in Android</a>
          
        </div>
      
      <nav class="md-nav" aria-label="Secure Coding Practices in Android" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_2_2">
          <span class="md-nav__icon md-icon"></span>
          Secure Coding Practices in Android
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc" checked
        onchange='(function(){
          var _pid = "__nav_2_2_2_1".slice(0, -2);
          var _pel = document.getElementById(_pid);
          _pel.checked  = false;
        })()'
      >
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Secure Coding Practices
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Secure Coding Practices
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-verify-for-security-early-and-often" class="md-nav__link">
    1. Verify for Security Early and Often
  </a>
  
    <nav class="md-nav" aria-label="1. Verify for Security Early and Often">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#securing-application-components" class="md-nav__link">
    Securing Application Components
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protecting-components-with-custom-permissions" class="md-nav__link">
    Protecting components with Custom Permissions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-parameterized-queries" class="md-nav__link">
    2. Parameterized Queries
  </a>
  
    <nav class="md-nav" aria-label="2. Parameterized Queries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sql-injection" class="md-nav__link">
    SQL Injection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preventing-command-injection" class="md-nav__link">
    Preventing Command Injection
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-encode-data" class="md-nav__link">
    3. Encode Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-validate-all-inputs" class="md-nav__link">
    4. Validate All Inputs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-implement-identity-and-authentication-controls" class="md-nav__link">
    5. Implement Identity and Authentication Controls
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-cryptographically-secure-data" class="md-nav__link">
    6. Cryptographically Secure Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-implement-logging-and-intrusion-detection" class="md-nav__link">
    7. Implement Logging and Intrusion Detection
  </a>
  
    <nav class="md-nav" aria-label="7. Implement Logging and Intrusion Detection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tamper-detection" class="md-nav__link">
    Tamper Detection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#responding-to-tamper-detection" class="md-nav__link">
    Responding to Tamper Detection
  </a>
  
    <nav class="md-nav" aria-label="Responding to Tamper Detection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#detect-if-google-play-store-was-the-installer" class="md-nav__link">
    Detect if Google Play store was the installer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-if-it-runs-on-an-emulator" class="md-nav__link">
    Detect if it runs on an Emulator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-if-it-runs-on-a-rooted-device" class="md-nav__link">
    Detect if it runs on a Rooted Device
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-if-the-app-has-the-debuggable-flag-enabled" class="md-nav__link">
    Detect if the app has the “debuggable” flag enabled
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#application-signature-verification" class="md-nav__link">
    Application Signature Verification
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#outputting-log-to-logcat" class="md-nav__link">
    Outputting Log to LogCat
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-leverage-security-frameworks-and-libraries" class="md-nav__link">
    8. Leverage Security Frameworks and Libraries
  </a>
  
    <nav class="md-nav" aria-label="8. Leverage Security Frameworks and Libraries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#securing-sharedpreferences-data-with-encrypted-sharedpreferences" class="md-nav__link">
    Securing SharedPreferences data with Encrypted SharedPreferences
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#encrypting-a-database-with-sqlcipher" class="md-nav__link">
    Encrypting a database with SQLCipher
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android-keystore-provider" class="md-nav__link">
    Android KeyStore Provider
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generating-a-symmetric-encryption-key" class="md-nav__link">
    Generating a Symmetric Encryption Key
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-monitor-error-and-exception-handling" class="md-nav__link">
    9. Monitor Error and Exception Handling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-handling-intents" class="md-nav__link">
    10. Handling Intents
  </a>
  
    <nav class="md-nav" aria-label="10. Handling Intents">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#intent-redirection" class="md-nav__link">
    Intent Redirection
  </a>
  
    <nav class="md-nav" aria-label="Intent Redirection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#private-vs-public-components-can-make-the-difference" class="md-nav__link">
    Private vs Public components can make the difference
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validating-the-source-of-the-intent" class="md-nav__link">
    Validating the source of the Intent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-sure-that-embedded-intent-is-not-harmful" class="md-nav__link">
    Make sure that embedded intent is not harmful
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../android-app-analysis" class="md-nav__link">
        Mobile Application Security Analysis
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../tags/">Tags</a>
          
        </div>
      
      <nav class="md-nav" aria-label="Tags" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Tags
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tags/" class="md-nav__link">
        Tags
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>

                
                
                    <br>
                    <br>
                    <div class="tag-cloud-nav">
                        





  

  

  

  
    
    
      
        
      
    
  

  
    
    
      
        
        
        
        
          
          
        
        
        
          
        
      
    
  

  


<style>
    .tag-cloud {
        margin-top:0;
        margin-bottom: 0.5em;
    }
    .tag-cloud-content {
        padding: 0 0.6rem;
        
    }
</style>

<p class="md-nav tag-cloud">
  <label class="md-nav__title">Tag cloud</label>
</p>
<div class="tag-cloud-content">
    
        
            
            
            
            <a class="tag" href="https://bhardwajabhi.github.io/MyBlogs/tags/#secure coding, secure coding practices, android security, android best practices">
                <span class="tag-name" style="
                    
                        
                    
                        font-size:0.55rem;
                    
                    color:DarkGoldenrod;
                ">secure coding, secure coding practices, android security, android best practices&nbsp;
                </span>
                <!--<sup class="tag-count">1</sup>-->
            </a>
        
            
            
            
            <a class="tag" href="https://bhardwajabhi.github.io/MyBlogs/tags/#mobile security trends, mobile security jobs">
                <span class="tag-name" style="
                    
                        
                    
                        font-size:0.55rem;
                    
                    color:DarkGreen;
                ">mobile security trends, mobile security jobs&nbsp;
                </span>
                <!--<sup class="tag-count">1</sup>-->
            </a>
        
    
</div>
                    </div>
                
            </div>
        </div>
    </div>



    

    <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
        <div class="md-sidebar__scrollwrap">
            <div class="md-sidebar__inner">
                
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-verify-for-security-early-and-often" class="md-nav__link">
    1. Verify for Security Early and Often
  </a>
  
    <nav class="md-nav" aria-label="1. Verify for Security Early and Often">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#securing-application-components" class="md-nav__link">
    Securing Application Components
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protecting-components-with-custom-permissions" class="md-nav__link">
    Protecting components with Custom Permissions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-parameterized-queries" class="md-nav__link">
    2. Parameterized Queries
  </a>
  
    <nav class="md-nav" aria-label="2. Parameterized Queries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sql-injection" class="md-nav__link">
    SQL Injection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preventing-command-injection" class="md-nav__link">
    Preventing Command Injection
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-encode-data" class="md-nav__link">
    3. Encode Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-validate-all-inputs" class="md-nav__link">
    4. Validate All Inputs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-implement-identity-and-authentication-controls" class="md-nav__link">
    5. Implement Identity and Authentication Controls
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-cryptographically-secure-data" class="md-nav__link">
    6. Cryptographically Secure Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-implement-logging-and-intrusion-detection" class="md-nav__link">
    7. Implement Logging and Intrusion Detection
  </a>
  
    <nav class="md-nav" aria-label="7. Implement Logging and Intrusion Detection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tamper-detection" class="md-nav__link">
    Tamper Detection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#responding-to-tamper-detection" class="md-nav__link">
    Responding to Tamper Detection
  </a>
  
    <nav class="md-nav" aria-label="Responding to Tamper Detection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#detect-if-google-play-store-was-the-installer" class="md-nav__link">
    Detect if Google Play store was the installer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-if-it-runs-on-an-emulator" class="md-nav__link">
    Detect if it runs on an Emulator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-if-it-runs-on-a-rooted-device" class="md-nav__link">
    Detect if it runs on a Rooted Device
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-if-the-app-has-the-debuggable-flag-enabled" class="md-nav__link">
    Detect if the app has the “debuggable” flag enabled
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#application-signature-verification" class="md-nav__link">
    Application Signature Verification
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#outputting-log-to-logcat" class="md-nav__link">
    Outputting Log to LogCat
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-leverage-security-frameworks-and-libraries" class="md-nav__link">
    8. Leverage Security Frameworks and Libraries
  </a>
  
    <nav class="md-nav" aria-label="8. Leverage Security Frameworks and Libraries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#securing-sharedpreferences-data-with-encrypted-sharedpreferences" class="md-nav__link">
    Securing SharedPreferences data with Encrypted SharedPreferences
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#encrypting-a-database-with-sqlcipher" class="md-nav__link">
    Encrypting a database with SQLCipher
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android-keystore-provider" class="md-nav__link">
    Android KeyStore Provider
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generating-a-symmetric-encryption-key" class="md-nav__link">
    Generating a Symmetric Encryption Key
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-monitor-error-and-exception-handling" class="md-nav__link">
    9. Monitor Error and Exception Handling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-handling-intents" class="md-nav__link">
    10. Handling Intents
  </a>
  
    <nav class="md-nav" aria-label="10. Handling Intents">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#intent-redirection" class="md-nav__link">
    Intent Redirection
  </a>
  
    <nav class="md-nav" aria-label="Intent Redirection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#private-vs-public-components-can-make-the-difference" class="md-nav__link">
    Private vs Public components can make the difference
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validating-the-source-of-the-intent" class="md-nav__link">
    Validating the source of the Intent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-sure-that-embedded-intent-is-not-harmful" class="md-nav__link">
    Make sure that embedded intent is not harmful
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                

                
                
            </div>
        </div>
    </div>


          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
    



<style>
    .md-typeset .cover {
        margin-bottom: 1em;
    }
    .md-typeset .page-category {
        color: gray;
        font-size: large;
    }
    .md-typeset .page-title {
        margin-left: -0.0625em;
    }
    .md-typeset .page-extra {
        color: gray;
        font-size: small;
    }
    .md-typeset .page-tags {
        margin: 0;
    }
    .md-typeset .page-date {
        margin: 0;
        text-align: end;
    }
    @media print {
        .md-typeset .cover {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .md-typeset .cover + * {
            margin-top: 0;
        }
    }
</style>

<div class="cover">
    
    

    
    <h1 class="page-title"> Secure Coding Practices </h1><p style="color:#bdbdbd"><i>Estimated time to read: 24 minutes</i></p>


    
    
        <p class="page-description">
            Coding practices that a developer need to follow in order to design and implement robust, rugged, and secure apps for Android device.
        </p>
    

    
        <div class="page-extra row">
            <div class="col">
            
                <p class="page-tags">
                    
                        <a class="tag" href="https://bhardwajabhi.github.io/MyBlogs/tags/#secure coding, secure coding practices, android security, android best practices">
                            <span class="tag-name">
                                #secure coding, secure coding practices, android security, android best practices &nbsp;
                            </span>
                        </a>
                    
                </p>
            
            
            </div>
            <div class="col">
                <p class="page-date">
                    <span>
                    
                        Last update:
                        2024-02-01
                    
                    </span>
                </p>
            </div>
        </div>
    
</div>

<hr class="screen-only">


<style>
    .md-typeset .toc {
        display: none;
    }
    .md-typeset .toc label {
        display: none;
    }
    .md-typeset .toc .md-nav {
        font-size: unset;
        line-height: 1.6;
    }
    .md-typeset .toc .md-nav--secondary {
        margin-left: -2em;
    }
    .md-typeset .toc .md-nav__list {
        margin: 0;
    }
    .md-typeset .toc ul {
        list-style: none;
    }
    @media print {
        .md-typeset .toc {
            display: block;
            page-break-after: always;
        }
        .md-typeset .toc .md-nav__link {
            color: var(--md-typeset-a-color);
        }
        .md-typeset .toc .md-nav__link.md-nav__link--active {
            font-weight: unset;
        }
        .md-typeset .toc + * {
            margin-top: 0;
        }
    }
</style>

<div class="toc">
    <h2>Table of Content</h2>
    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-verify-for-security-early-and-often" class="md-nav__link">
    1. Verify for Security Early and Often
  </a>
  
    <nav class="md-nav" aria-label="1. Verify for Security Early and Often">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#securing-application-components" class="md-nav__link">
    Securing Application Components
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protecting-components-with-custom-permissions" class="md-nav__link">
    Protecting components with Custom Permissions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-parameterized-queries" class="md-nav__link">
    2. Parameterized Queries
  </a>
  
    <nav class="md-nav" aria-label="2. Parameterized Queries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sql-injection" class="md-nav__link">
    SQL Injection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preventing-command-injection" class="md-nav__link">
    Preventing Command Injection
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-encode-data" class="md-nav__link">
    3. Encode Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-validate-all-inputs" class="md-nav__link">
    4. Validate All Inputs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-implement-identity-and-authentication-controls" class="md-nav__link">
    5. Implement Identity and Authentication Controls
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-cryptographically-secure-data" class="md-nav__link">
    6. Cryptographically Secure Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-implement-logging-and-intrusion-detection" class="md-nav__link">
    7. Implement Logging and Intrusion Detection
  </a>
  
    <nav class="md-nav" aria-label="7. Implement Logging and Intrusion Detection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tamper-detection" class="md-nav__link">
    Tamper Detection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#responding-to-tamper-detection" class="md-nav__link">
    Responding to Tamper Detection
  </a>
  
    <nav class="md-nav" aria-label="Responding to Tamper Detection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#detect-if-google-play-store-was-the-installer" class="md-nav__link">
    Detect if Google Play store was the installer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-if-it-runs-on-an-emulator" class="md-nav__link">
    Detect if it runs on an Emulator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-if-it-runs-on-a-rooted-device" class="md-nav__link">
    Detect if it runs on a Rooted Device
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-if-the-app-has-the-debuggable-flag-enabled" class="md-nav__link">
    Detect if the app has the “debuggable” flag enabled
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#application-signature-verification" class="md-nav__link">
    Application Signature Verification
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#outputting-log-to-logcat" class="md-nav__link">
    Outputting Log to LogCat
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-leverage-security-frameworks-and-libraries" class="md-nav__link">
    8. Leverage Security Frameworks and Libraries
  </a>
  
    <nav class="md-nav" aria-label="8. Leverage Security Frameworks and Libraries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#securing-sharedpreferences-data-with-encrypted-sharedpreferences" class="md-nav__link">
    Securing SharedPreferences data with Encrypted SharedPreferences
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#encrypting-a-database-with-sqlcipher" class="md-nav__link">
    Encrypting a database with SQLCipher
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android-keystore-provider" class="md-nav__link">
    Android KeyStore Provider
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generating-a-symmetric-encryption-key" class="md-nav__link">
    Generating a Symmetric Encryption Key
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-monitor-error-and-exception-handling" class="md-nav__link">
    9. Monitor Error and Exception Handling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-handling-intents" class="md-nav__link">
    10. Handling Intents
  </a>
  
    <nav class="md-nav" aria-label="10. Handling Intents">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#intent-redirection" class="md-nav__link">
    Intent Redirection
  </a>
  
    <nav class="md-nav" aria-label="Intent Redirection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#private-vs-public-components-can-make-the-difference" class="md-nav__link">
    Private vs Public components can make the difference
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validating-the-source-of-the-intent" class="md-nav__link">
    Validating the source of the Intent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-sure-that-embedded-intent-is-not-harmful" class="md-nav__link">
    Make sure that embedded intent is not harmful
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
</div>



    
    <h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">#</a></h2>
<p>With the Android platform fast becoming a target of malicious hackers, applications security is no longer an add-on, but a crucial part of the developer’s job.</p>
<p>This post provides secure coding practices that a developer need to follow in order to design and implement robust, rugged, and secure apps for Android device.</p>
<h2 id="1-verify-for-security-early-and-often">1. Verify for Security Early and Often<a class="headerlink" href="#1-verify-for-security-early-and-often" title="Permanent link">#</a></h2>
<h3 id="securing-application-components">Securing Application Components<a class="headerlink" href="#securing-application-components" title="Permanent link">#</a></h3>
<ul>
<li>
<p>Application Components are the essential building blocks of an Android Application.</p>
</li>
<li>
<p>Each component is an entry point through which the system or a user can enter your application.</p>
</li>
<li>
<p>Four major Android Application Components are: </p>
<ul>
<li>Activities</li>
<li>Services</li>
<li>Content Providers</li>
<li>Broadcast Receivers</li>
</ul>
</li>
<li>
<p>One of the common mistakes while developing applications is unintentionally leaving application components exposed.</p>
</li>
<li>
<p>Application components can be secured both by making proper use of the <mark><strong>AndroidManifest.xml</strong></mark> file and by forcing permission checks at code level.</p>
</li>
<li>
<p>These two factors of application security make the permissions framework quite flexible and allow you to limit the number of applications accessing your components in quite a granular way.</p>
</li>
<li>
<p>The <mark><strong>android:exported</strong></mark> attribute defines whether a component can be invoked by other applications.</p>
</li>
<li>
<p>If any of your application components do not need to be invoked by other applications or need to be explicitly shielded from interaction with the components on the rest of the Android system (other than components internal to your application)</p>
</li>
<li>
<p>You should add the following attribute to the application component&rsquo;s XML element:</p>
</li>
</ul>
<div class="highlight"><span class="filename">AndroidManifest.xml</span><pre><span></span><code><span class="hll"><span class="linenos" data-linenos="1 "></span><span class="o">&lt;[</span><span class="n">component</span><span class="o">-</span><span class="n">name</span><span class="o">]</span><span class="w"> </span><span class="n">android</span><span class="p">:</span><span class="n">exported</span><span class="o">=</span><span class="s">&quot;false&quot;</span><span class="o">&gt;</span>
</span><span class="linenos" data-linenos="2 "></span><span class="p">...</span>
<span class="linenos" data-linenos="3 "></span><span class="o">&lt;/[</span><span class="n">component</span><span class="o">-</span><span class="n">name</span><span class="o">]&gt;</span>
</code></pre></div>
<ul>
<li>Here the [component name] would either be an activity, provider, service or a receiver.</li>
</ul>
<h3 id="protecting-components-with-custom-permissions">Protecting components with Custom Permissions<a class="headerlink" href="#protecting-components-with-custom-permissions" title="Permanent link">#</a></h3>
<ul>
<li>
<p>The Android platform defines a set of default permissions which are used to secure system services and application components.</p>
</li>
<li>
<p>Largely, these permissions work in the most generic case, but often when sharing bespoke functionality or components between applications it will require a more tailored use of the permissions framework.</p>
</li>
<li>
<p><strong>This is facilitated by defining custom permissions</strong>.</p>
</li>
</ul>
<hr />
<p><strong>Following snippets demonstrates how you can define your own custom permissions</strong>:</p>
<ol>
<li>
<p>Before adding any custom permissions, you need to declare string resources for the permission labels. You can do this by editing the strings.xml file in your application project folder under <mark><strong>res/values/strings.xml</strong></mark>:
<div class="highlight"><span class="filename">res/values/strings.xml</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="o">&lt;</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;custom_permission_label&quot;</span><span class="o">&gt;</span><span class="n">Custom</span><span class="w"> </span><span class="n">Permission</span><span class="o">&lt;/</span><span class="n">string</span><span class="o">&gt;</span>
</code></pre></div></p>
</li>
<li>
<p>Adding normal protection-level custom permissions to your application can be done by adding the following lines to your <mark><strong>AndroidManifest.xml</strong></mark> file:
<div class="highlight"><span class="filename">AndroidManifest.xml</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="o">&lt;</span><span class="n">permission</span><span class="w"> </span><span class="n">android</span><span class="p">:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;android.permission.CUSTOM_PERMISSION&quot;</span>
<span class="linenos" data-linenos="2 "></span><span class="nl">android</span><span class="p">:</span><span class="n">protectionLevel</span><span class="o">=</span><span class="s">&quot;normal&quot;</span>
<span class="linenos" data-linenos="3 "></span><span class="nl">android</span><span class="p">:</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;my custom permission&quot;</span>
<span class="linenos" data-linenos="4 "></span><span class="nl">android</span><span class="p">:</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;@string/custom_permission_label&quot;</span><span class="o">&gt;</span>
</code></pre></div></p>
</li>
<li>
<p>Making use of this permission works the same as any other permission; you need to add it to the <mark><strong>android:permission</strong></mark> attribute of an application component.
<div class="highlight"><span class="filename">AndroidManifest.xml</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="o">&lt;[</span><span class="n">component</span><span class="o">-</span><span class="n">name</span><span class="o">]</span><span class="w"> </span><span class="p">...</span>
<span class="linenos" data-linenos="2 "></span><span class="w">    </span><span class="n">android</span><span class="p">:</span><span class="n">permission</span><span class="o">=</span><span class="s">&quot;android.permission.CUSTOM_PERMISSION&quot;</span><span class="o">&gt;</span>
<span class="linenos" data-linenos="3 "></span><span class="o">&lt;/[</span><span class="n">component</span><span class="o">-</span><span class="n">name</span><span class="o">]&gt;</span>
</code></pre></div>
Here the [component name] would either be an activity, provider, service or a receiver.</p>
</li>
<li>
<p>You can also allow other applications to request this permission by adding the <mark><strong>&lt;uses-permission/&gt;</strong></mark> tag to an application&rsquo;s AndroidManifest.xml file:
<div class="highlight"><span class="filename">AndroidManifest.xml</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="o">&lt;</span><span class="n">uses</span><span class="o">-</span><span class="n">permission</span><span class="w"> </span><span class="n">android</span><span class="p">:</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;android.permission.CUSTOM_PERMISSION&quot;</span><span class="o">/&gt;</span>
</code></pre></div></p>
</li>
</ol>
<p><strong>The breakdown of the attributes of <mark><strong>&lt;permission&gt;</strong></mark> element is as follows</strong>:</p>
<ul>
<li>
<p><strong>android:name</strong> - This defines the name of the permissions, which is the string value that will be used to reference this permission.</p>
</li>
<li>
<p><strong>android:protectionLevel</strong> - This defines the protection level of the permission and controls whether users will be prompted to grant the permission. Following are the Protection Levels:</p>
<ul>
<li>
<p><strong>normal</strong> -  This permission is used to define non dangerous permissions, these permissions will not be prompted and may be granted autonomously.</p>
</li>
<li>
<p><strong>dangerous</strong> - This permission is used to define permissions that expose the user to considerable fiscal, reputational, and legal risk.</p>
</li>
<li>
<p><strong>signature</strong> -  This permission is granted autonomously to applications that are signed with the same key as the application that defines them.</p>
</li>
<li>
<p><strong>signatureOrSystem</strong> - This permission is automatically granted to any application that forms a part of the system image or is signed with the same key as the application that defines them.</p>
</li>
</ul>
</li>
</ul>
<h2 id="2-parameterized-queries">2. Parameterized Queries<a class="headerlink" href="#2-parameterized-queries" title="Permanent link">#</a></h2>
<h3 id="sql-injection">SQL Injection<a class="headerlink" href="#sql-injection" title="Permanent link">#</a></h3>
<ul>
<li>
<p>One specific form of a class of vulnerabilities known as command injection.</p>
</li>
<li>
<p>In this type of vulnerability, input from an outside source is used directly as part of a command, in this case a SQL expression that is passed to a database interpreter.</p>
</li>
</ul>
<p><strong>For Example:</strong></p>
<ul>
<li>
<p>consider a case where the user supplies a username and password to an application, which must then verify that the combination is valid to allow access.
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">String</span><span class="w"> </span><span class="n">loginQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SELECT * FROM useraccounts WHERE userID = &#39;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&quot;userID&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39; AND password = &#39;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;&quot;</span><span class="p">;</span>
</code></pre></div></p>
</li>
<li>
<p>However, if whoever is submitting the information were to submit these values:
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">userID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">--</span>
<span class="linenos" data-linenos="2 "></span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">doesNotMatter</span>
</code></pre></div></p>
</li>
<li>
<p>The resulting query that would be supplied to the SQL database interpreter would be:
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">FROM</span><span class="w"> </span><span class="n">useraccounts</span><span class="w"> </span><span class="n">WHERE</span><span class="w"> </span><span class="n">userID</span><span class="o">=</span><span class="err">&#39;&#39;</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">AND</span><span class="w"> </span><span class="n">password</span><span class="o">=</span><span class="err">&#39;</span><span class="n">doesNotMatter</span><span class="err">&#39;</span>
</code></pre></div>
This SQL statement would then evaluate and return all of the data from the user accounts table, as the WHERE condition would always be true (due to the OR 1=1 condition) and the password checking clause would be commented out.</p>
</li>
</ul>
<hr />
<p><strong>This unintended behavior is made possible because of two primary problems.</strong></p>
<ul>
<li>
<p><strong>First</strong>, our app did not properly validate the input that was received before using that input to form the SQL statement to be submitted to the database interpreter.</p>
</li>
<li>
<p><strong>Second</strong>, the problem is enabled because when query strings are constructed in such a manner, the database system cannot tell the difference between code and data; the initial apostrophe <mark>(&lsquo;)</mark> submitted in the <em>userID</em> is actually data, but is being interpreted as code because the database cannot tell that it should be interpreted as a literal data value.</p>
</li>
</ul>
<h3 id="preventing-command-injection">Preventing Command Injection<a class="headerlink" href="#preventing-command-injection" title="Permanent link">#</a></h3>
<ul>
<li>
<p>Looking at an example similar to the earlier one.</p>
</li>
<li>
<p>Let&rsquo;s consider looking up a user’s last name in a database. The unsafe way to form this statement looks something like this:
<div class="highlight"><span class="filename">Non-Compliant Code</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">SQLiteDatabase</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dbHelper</span><span class="p">.</span><span class="na">getWriteableDatabase</span><span class="p">();</span>
<span class="linenos" data-linenos="2 "></span><span class="n">String</span><span class="w"> </span><span class="n">userQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SELECT lastName FROM useraccounts WHERE userID = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&quot;userID&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="3 "></span><span class="n">String</span><span class="w"> </span><span class="n">userLastName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prepStatement</span><span class="p">.</span><span class="na">simpleQueryForString</span><span class="p">();</span>
</code></pre></div></p>
</li>
<li>
<p>Here is the proper way to perform such a query against the database, where the command is separated from the data:
<div class="highlight"><span class="filename">Compliant Code</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">SQLiteDatabase</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dbHelper</span><span class="p">.</span><span class="na">getWriteableDatabase</span><span class="p">();</span>
<span class="linenos" data-linenos="2 "></span><span class="n">String</span><span class="w"> </span><span class="n">userQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SELECT lastName FROM useraccounts WHERE userID = ?&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="3 "></span><span class="n">SQLiteStatement</span><span class="w"> </span><span class="n">prepStatement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="na">compileStatement</span><span class="w"> </span><span class="p">(</span><span class="n">userQuery</span><span class="p">);</span>
<span class="linenos" data-linenos="4 "></span><span class="n">prepStatement</span><span class="p">.</span><span class="na">bindString</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&quot;userID&quot;</span><span class="p">));</span><span class="w"> </span>
<span class="linenos" data-linenos="5 "></span><span class="n">String</span><span class="w"> </span><span class="n">userLastName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prepStatement</span><span class="p">.</span><span class="na">simpleQueryForString</span><span class="p">();</span>
</code></pre></div></p>
</li>
</ul>
<p>By taking advantage of the <strong>compileStatement</strong> capability, we can effectively separate commands from data in SQL statements, by using the <mark><strong>?</strong></mark> marker. This is known as a parameterized query, as the query string includes placeholders <mark>(question marks)</mark> to mark the data and the values for those pieces of data are filled in independently (by the bindString() call in our example).</p>
<h2 id="3-encode-data">3. Encode Data<a class="headerlink" href="#3-encode-data" title="Permanent link">#</a></h2>
<ul>
<li>
<p>Encoding your data is a solution you should consider if you work with slightly less sensitive data or are looking for a way to organize your data.</p>
</li>
<li>
<p>Most encoding methods rely on algorithms to compress the data and reduce its complexity.</p>
</li>
<li>
<p>The same algorithm used to encode the data is needed to access the data in a readable format.</p>
</li>
<li>
<p>Encoding keeps your data safe since the data is not readable unless you have access to the algorithms that were used to encode it.</p>
</li>
<li>
<p>This is a good way to protect your data from theft since any stolen data would not be usable.</p>
</li>
<li>
<p>Encoding is an ideal solution if you need to have third parties access your data but do not want to have everyone be able to access some sensitive data.</p>
</li>
<li>
<p>Since encoding removes redundancies from data, the size of your data will be a lot smaller.</p>
</li>
<li>
<p>This results in faster input speed when data is processed or saved.
Since encoded data is smaller in size, you should be able to save space on your storage devices.</p>
</li>
<li>
<p>Encoded data is easy to organize, even if the original data was mostly unstructured.</p>
</li>
<li>
<p>This is how we can encode a normal string to a Base64 encoding scheme.
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">String</span><span class="w"> </span><span class="n">testValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Hello, world!&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="2 "></span>
<span class="linenos" data-linenos="3 "></span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">encodeValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">encode</span><span class="p">(</span><span class="n">testValue</span><span class="p">.</span><span class="na">getBytes</span><span class="p">(),</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span>
<span class="linenos" data-linenos="4 "></span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">decodeValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">decode</span><span class="p">(</span><span class="n">encodeValue</span><span class="p">,</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span>
<span class="linenos" data-linenos="5 "></span>
<span class="linenos" data-linenos="6 "></span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="s">&quot;ENCODE_DECODE&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;defaultValue = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">testValue</span><span class="p">);</span>
<span class="linenos" data-linenos="7 "></span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="s">&quot;ENCODE_DECODE&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;encodeValue = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">encodeValue</span><span class="p">));</span>
<span class="linenos" data-linenos="8 "></span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="s">&quot;ENCODE_DECODE&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;decodeValue = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">decodeValue</span><span class="p">));</span>
</code></pre></div>
<div class="highlight"><span class="filename">Output</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Hello</span><span class="p">,</span><span class="w"> </span><span class="n">world</span><span class="o">!</span>
<span class="linenos" data-linenos="2 "></span><span class="n">encodeValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SGVsbG8sIHdvcmxkIQ</span><span class="o">==</span>
<span class="linenos" data-linenos="3 "></span><span class="n">decodeValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Hello</span><span class="p">,</span><span class="w"> </span><span class="n">world</span><span class="o">!</span>
</code></pre></div></p>
</li>
</ul>
<h2 id="4-validate-all-inputs">4. Validate All Inputs<a class="headerlink" href="#4-validate-all-inputs" title="Permanent link">#</a></h2>
<ul>
<li>
<p>Input validation is the key component of application security.</p>
</li>
<li>
<p><strong>One of the primary problems in applications is that developers trust that input</strong>.</p>
</li>
<li>
<p>Remember that any piece of data submitted from outside your app can be submitted by, or manipulated by, an attacker.</p>
</li>
<li>
<p>You need to verify that the data received by your application is valid and safe to process.</p>
</li>
<li>
<p>Validating input data is the easiest and yet most effective secure coding method.</p>
</li>
<li>
<p>All data that is inputted into the application either directly or indirectly by an outside source needs to be properly validated.</p>
</li>
</ul>
<p><strong>For Example</strong>:</p>
<ul>
<li>
<p>Following is an example of an Activity as used in a program that receives data from Intent:
<div class="highlight"><span class="filename">Non-Compliant Code</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">TextView</span><span class="w"> </span><span class="n">tv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TextView</span><span class="p">)</span><span class="w"> </span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">textview</span><span class="p">);</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">InputStreamReader</span><span class="w"> </span><span class="n">isr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kt">char</span><span class="w"> </span><span class="o">[]</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="o">[</span><span class="mi">1024</span><span class="o">]</span><span class="p">;</span>
<span class="linenos" data-linenos=" 4 "></span><span class="kt">int</span><span class="w"> </span><span class="n">read</span><span class="p">;</span>
<span class="linenos" data-linenos=" 5 "></span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">urlstr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIntent</span><span class="p">().</span><span class="na">getStringExtra</span><span class="p">(</span><span class="s">&quot;WEBPAGE_URL&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="n">URL</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">urlstr</span><span class="p">);</span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="n">isr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InputStreamReader</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="na">openConnection</span><span class="p">().</span><span class="na">getInputStream</span><span class="p">());</span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="k">while</span><span class="p">((</span><span class="n">read</span><span class="o">=</span><span class="n">isr</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">text</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="10 "></span><span class="w">        </span><span class="n">tv</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">read</span><span class="p">));</span>
<span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="p">}</span>
<span class="linenos" data-linenos="12 "></span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">MalformedURLException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{...}</span>
</code></pre></div></p>
</li>
<li>
<p>The example is a simple sample where HTML is acquired from a remote web page in a designated URL and the code is displayed in TextView.</p>
</li>
<li>
<p>However, this is not sufficient.</p>
</li>
<li>
<p>Furthermore, when a <mark><strong>“file://…”</strong></mark> formatted URL is designated by urlstr, the file of the internal file system is opened and is displayed in TextView rather than the remote web page.</p>
</li>
<li>
<p><strong>The below example shows a revision to fix the security bugs:</strong>
<div class="highlight"><span class="filename">Compliant Code</span><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">TextView</span><span class="w"> </span><span class="n">tv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TextView</span><span class="p">)</span><span class="w"> </span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">textview</span><span class="p">);</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">InputStreamReader</span><span class="w"> </span><span class="n">isr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kt">char</span><span class="w"> </span><span class="o">[]</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="o">[</span><span class="mi">1024</span><span class="o">]</span><span class="p">;</span>
<span class="linenos" data-linenos=" 4 "></span><span class="kt">int</span><span class="w"> </span><span class="n">read</span><span class="p">;</span>
<span class="linenos" data-linenos=" 5 "></span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">urlstr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIntent</span><span class="p">().</span><span class="na">getStringExtra</span><span class="p">(</span><span class="s">&quot;WEBPAGE_URL&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="n">URL</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">urlstr</span><span class="p">);</span>
<span class="hll"><span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">prot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">url</span><span class="p">.</span><span class="na">getProtocol</span><span class="p">();</span>
</span><span class="hll"><span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="s">&quot;http&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">prot</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="s">&quot;https&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">prot</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="linenos" data-linenos="10 "></span><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MalformedURLException</span><span class="p">(</span><span class="s">&quot;invalid protocol&quot;</span><span class="p">);</span>
</span><span class="hll"><span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="p">}</span>
</span><span class="linenos" data-linenos="12 "></span><span class="w">    </span><span class="n">isr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InputStreamReader</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="na">openConnection</span><span class="p">().</span><span class="na">getInputStream</span><span class="p">());</span>
<span class="linenos" data-linenos="13 "></span><span class="w">    </span><span class="k">while</span><span class="p">((</span><span class="n">read</span><span class="o">=</span><span class="n">isr</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">text</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="14 "></span><span class="w">        </span><span class="n">tv</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">read</span><span class="p">));</span>
<span class="linenos" data-linenos="15 "></span><span class="w">    </span><span class="p">}</span>
<span class="linenos" data-linenos="16 "></span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">MalformedURLException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{...}</span>
</code></pre></div></p>
</li>
</ul>
<p>Validating the safety of input data is called <strong>“Input Validation”</strong> and it is a fundamental secure coding method.</p>
<h2 id="5-implement-identity-and-authentication-controls">5. Implement Identity and Authentication Controls<a class="headerlink" href="#5-implement-identity-and-authentication-controls" title="Permanent link">#</a></h2>
<ul>
<li>
<p>Providing a secure login mechanism for your users is harder than on the Web.</p>
</li>
<li>
<p>The trend on mobile devices is to make things as easy as possible for the user.</p>
</li>
<li>
<p>But if you make it too easy to login into your app, you run the risk of unauthorized users gaining access to sensitive data by going around this authentication.</p>
</li>
<li>
<p>The following tokens are common on Android devices as a part of login process:</p>
<ul>
<li>Username and Password</li>
<li>Device information, such as DeviceID and AndroidID</li>
<li>Network information, such as IP address</li>
</ul>
</li>
<li>
<p>The classic login of username and password is still the most common authentication on an Android phone.</p>
</li>
<li>
<p>Let’s look at some best practices for user authentication. </p>
</li>
<li>
<p>The best practices are as follows:</p>
<ul>
<li>No password caching</li>
<li>Minimum password length</li>
<li>Multi-factor authentication</li>
<li>Server-side as well as client-side authentication</li>
</ul>
</li>
<li>
<p>Do not save or cache username, and especially password, information on the phone, as there is always a risk that it will be found and decrypted. </p>
</li>
<li>
<p>Even if you’re encrypting the password, if you’re also storing the key in the APK then it’s going to be unencrypted.</p>
</li>
<li>
<p>It is better not to store passwords, if you can get away with it, and make the user Log In each time.</p>
</li>
<li>
<p><strong>Try to enforce a minimum password length</strong> - passwords of less than six characters are highly prone to a brute force attack. Financial apps should have stricter policies than other apps.</p>
</li>
<li>
<p><strong>Validate email addresses</strong> - this can be done either using regular expressions or via an email link during setup or, better still, using both approaches.</p>
</li>
<li>
<p>If you do update your password standards, notify your existing customers when they login again to update their passwords.</p>
</li>
<li>
<p>It’s becoming very common for applications to use a <strong>Two-Factor Authentication</strong> where a randomly generated PIN number is sent via SMS message to user’s phone before he can log in to the application. </p>
</li>
<li>
<p>We can also use the info like DeviceID, IP Address, and Location information to add extra layers of information.</p>
</li>
<li>
<p><strong>Access control</strong> doesn’t end at the client; it needs to be enforced at the server, too. </p>
</li>
<li>
<p>Some back-end servers mistakenly rely on the client app to perform all authentication and assume that the web server doesn’t need to do any authentication.</p>
</li>
<li>
<p>The server should also check for valid credentials each time or use a session token once again over SSL.</p>
</li>
<li>
<p>It should also check for unusual activity, such as someone performing a bruteforce attack, and notify the user via email of unusual login activity.</p>
</li>
<li>
<p>If you are saving any personal, healthcare, or financial information, you should use an <strong>asymmetric</strong> or <strong>public/private</strong> key. </p>
</li>
<li>
<p>This does require a round trip back to the server to decrypt the data, but if the phone is compromised, the user’s data will remain secure.</p>
</li>
<li>
<p>Only the private key can decrypt the data, and that should never be stored on the phone.</p>
</li>
</ul>
<h2 id="6-cryptographically-secure-data">6. Cryptographically Secure Data<a class="headerlink" href="#6-cryptographically-secure-data" title="Permanent link">#</a></h2>
<ul>
<li>
<p>Encryption techniques are frequently used to ensure confidentiality and integrity, and Android is equipped with a variety of cryptographic features to allow applications to realize confidentiality and integrity.</p>
</li>
<li>
<p>You may use password-based key encryption for the purpose of protecting a user’s confidential data assets.</p>
</li>
<li>
<p><strong>Key Points to consider while Encrypting and Decrypting with Password-based keys</strong>:</p>
<ul>
<li>Explicitly specify the encryption mode and the padding.</li>
<li>Use strong encryption technologies including algorithms, block cipher modes, and padding modes.</li>
<li>When generating a key from password, use Salt.</li>
<li>When generating a key from password, specify an appropriate hash iteration count.</li>
<li>Use a key of length sufficient to guarantee the strength of encryption.</li>
</ul>
</li>
</ul>
<hr />
<p>Here is the complete listing that will allow the encryption or decryption of data based on a password:
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">;</span>
<span class="linenos" data-linenos=" 2 "></span><span class="n">String</span><span class="w"> </span><span class="n">PBE_ALGORITHM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;PBEWithSHA256And256BitAES-CBC-BC&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">String</span><span class="w"> </span><span class="n">CIPHER_ALGORITHM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;AES/CHC/PKCSSPadding&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 4 "></span><span class="kt">int</span><span class="w"> </span><span class="n">NUM_OF_ITERATIONS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
<span class="linenos" data-linenos=" 5 "></span><span class="kt">int</span><span class="w"> </span><span class="n">KEY_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecureRandom</span><span class="p">.</span><span class="na">nextBytes</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="mi">8</span><span class="o">]</span><span class="p">);</span>
<span class="linenos" data-linenos=" 8 "></span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">iv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecureRandom</span><span class="p">.</span><span class="na">nextBytes</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="mi">16</span><span class="o">]</span><span class="p">);</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="n">String</span><span class="w"> </span><span class="n">clearText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="c1">// The value to be encrypted</span>
<span class="linenos" data-linenos="11 "></span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">encryptedText</span><span class="p">:</span>
<span class="linenos" data-linenos="12 "></span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">decryptedtext</span><span class="p">;</span>
<span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span><span class="k">try</span><span class="p">{</span>
<span class="linenos" data-linenos="15 "></span><span class="w">    </span><span class="n">PBEKeySpec</span><span class="w"> </span><span class="n">pbeKeySpec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PBEKeySpec</span><span class="p">(</span><span class="n">password</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">(),</span><span class="w"> </span><span class="n">salt</span><span class="p">,</span><span class="w"> </span><span class="n">NUM_OF_ITERATIONS</span><span class="p">,</span><span class="w"> </span><span class="n">KEY_SIZE</span><span class="p">);</span>
<span class="linenos" data-linenos="16 "></span>
<span class="linenos" data-linenos="17 "></span><span class="w">    </span><span class="n">SecretKeyFactory</span><span class="w"> </span><span class="n">keyFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SecretKeyFactory</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">PBE_ALGORITHM</span><span class="p">);</span>
<span class="linenos" data-linenos="18 "></span><span class="w">    </span><span class="n">SecretKey</span><span class="w"> </span><span class="n">secretKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyFactory</span><span class="p">.</span><span class="na">generateSecret</span><span class="p">(</span><span class="n">pbeKeySpec</span><span class="p">);</span>
<span class="linenos" data-linenos="19 "></span><span class="w">    </span><span class="n">SecretKeySpec</span><span class="w"> </span><span class="n">secretKeySpec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecretKeySpec</span><span class="p">(</span><span class="n">secretKey</span><span class="p">.</span><span class="na">getEncoded</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;AES&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="20 "></span>
<span class="linenos" data-linenos="21 "></span><span class="w">    </span><span class="n">IvParameterSpec</span><span class="w"> </span><span class="n">ivSpec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IvParameterSpec</span><span class="p">(</span><span class="n">iv</span><span class="p">):</span>
<span class="linenos" data-linenos="22 "></span>
<span class="linenos" data-linenos="23 "></span><span class="w">    </span><span class="n">Cipher</span><span class="w"> </span><span class="n">encCipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">CIPHER_ALGORITHM</span><span class="p">);</span>
<span class="linenos" data-linenos="24 "></span><span class="w">    </span><span class="n">encCipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">ENCRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">secretKeySpec</span><span class="p">,</span><span class="w"> </span><span class="n">ivSpec</span><span class="p">);</span>
<span class="linenos" data-linenos="25 "></span>
<span class="linenos" data-linenos="26 "></span><span class="w">    </span><span class="n">Cipher</span><span class="w"> </span><span class="n">decCipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getinstance</span><span class="p">(</span><span class="n">CIPHER_ALGORITHM</span><span class="p">);</span>
<span class="linenos" data-linenos="27 "></span><span class="w">    </span><span class="n">decCipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">DECRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">secretKeySpec</span><span class="p">,</span><span class="w"> </span><span class="n">ivSpec</span><span class="p">);</span>
<span class="linenos" data-linenos="28 "></span>
<span class="linenos" data-linenos="29 "></span><span class="w">    </span><span class="n">encryptedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">encCipher</span><span class="p">.</span><span class="na">doFinal</span><span class="p">(</span><span class="n">clearText</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span>
<span class="linenos" data-linenos="30 "></span><span class="w">    </span><span class="n">decyptedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decCipher</span><span class="p">.</span><span class="na">doFinal</span><span class="p">(</span><span class="n">encryptedText</span><span class="p">);</span>
<span class="linenos" data-linenos="31 "></span>
<span class="linenos" data-linenos="32 "></span><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">sameAsClearText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">decryptedText</span><span class="p">);</span>
<span class="linenos" data-linenos="33 "></span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="34 "></span><span class="w">    </span><span class="p">...</span>
<span class="linenos" data-linenos="35 "></span><span class="p">}</span>
</code></pre></div></p>
<hr />
<p>In the above snippet:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">String</span><span class="w"> </span><span class="n">PBE_ALGORITHM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;PBEWithSHA256And256BitAES-CBC-BC&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="2 "></span><span class="n">String</span><span class="w"> </span><span class="n">CIPHER_ALGORITHM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;AES/CHC/PKCSSPadding&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="3 "></span><span class="kt">int</span><span class="w"> </span><span class="n">NUM_OF_ITERATIONS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
<span class="linenos" data-linenos="4 "></span><span class="kt">int</span><span class="w"> </span><span class="n">KEY_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>
</code></pre></div>
<ul>
<li>
<p>This section of code just sets up the algorithms and parameters we are going to use.</p>
</li>
<li>
<p>Here we are using SHA-256 as the Hashing algorithm and AES in CBC mode as the Encryption Algorithm.</p>
</li>
<li>
<p>We will use 1,000 iterations of the hashing function during the process and will end up with a 256-bit key.</p>
</li>
<li>
<p>We will be using AES, still in Cipher Block Chaining mode, and employ PKCS#5 padding. The padding setting specified how to pad the data being encrypted (or decrypted) if it is not in multiples of 128 bits, as AES operates on blocks of 128 bits at a time. </p>
</li>
<li>
<p>These all are standard algorithms and parameters, representing a strong encryption scheme.</p>
</li>
</ul>
<hr />
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecureRandom</span><span class="p">.</span><span class="na">nextBytes</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="mi">8</span><span class="o">]</span><span class="p">);</span>
<span class="linenos" data-linenos="2 "></span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">iv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecureRandom</span><span class="p">.</span><span class="na">nextBytes</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="mi">16</span><span class="o">]</span><span class="p">);</span>
</code></pre></div>
<ul>
<li>Here, we set up the <strong>Salt</strong> that will be used in the key derivation computation and the <strong>Initialization Vector</strong> (IV) that will be used in encryption and decryption of data.</li>
</ul>
<hr />
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">String</span><span class="w"> </span><span class="n">clearText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="c1">// The value to be encrypted</span>
<span class="linenos" data-linenos="2 "></span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">encryptedText</span><span class="p">:</span>
<span class="linenos" data-linenos="3 "></span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">decryptedtext</span><span class="p">;</span>
</code></pre></div>
<ul>
<li>
<p>Here, we just set up the values we will encrypt and decrypt. </p>
</li>
<li>
<p>For the purpose of this example, <strong>clearText</strong> will hold the string we want to encrypt.</p>
</li>
<li>
<p><strong>encryptedText</strong> is a byte array that will hold the encrypted value of the string.</p>
</li>
<li>
<p><strong>decryptedText</strong> will hold the decrypted bytes, once we encrypt the string and then decrypt it.</p>
</li>
</ul>
<hr />
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">PBEKeySpec</span><span class="w"> </span><span class="n">pbeKeySpec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PBEKeySpec</span><span class="p">(</span><span class="n">password</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">(),</span><span class="w"> </span><span class="n">salt</span><span class="p">,</span><span class="w"> </span><span class="n">NUM_OF_ITERATIONS</span><span class="p">,</span><span class="w"> </span><span class="n">KEY_SIZE</span><span class="p">);</span>
<span class="linenos" data-linenos="2 "></span><span class="n">SecretKeyFactory</span><span class="w"> </span><span class="n">keyFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SecretKeyFactory</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">PBE_ALGORITHM</span><span class="p">);</span>
<span class="linenos" data-linenos="3 "></span><span class="n">SecretKey</span><span class="w"> </span><span class="n">secretKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyFactory</span><span class="p">.</span><span class="na">generateSecret</span><span class="p">(</span><span class="n">pbeKeySpec</span><span class="p">);</span>
<span class="linenos" data-linenos="4 "></span><span class="n">SecretKeySpec</span><span class="w"> </span><span class="n">secretKeySpec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecretKeySpec</span><span class="p">(</span><span class="n">secretKey</span><span class="p">.</span><span class="na">getEncoded</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;AES&quot;</span><span class="p">);</span>
</code></pre></div>
<ul>
<li>Here, we perform key derivation, going from the user-supplied password to a 256-bit AES key.</li>
</ul>
<hr />
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">IvParameterSpec</span><span class="w"> </span><span class="n">ivSpec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IvParameterSpec</span><span class="p">(</span><span class="n">iv</span><span class="p">):</span>
</code></pre></div>
<ul>
<li>We then set up the Initialization Vector (IV) like this.</li>
</ul>
<hr />
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">Cipher</span><span class="w"> </span><span class="n">encCipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">CIPHER_ALGORITHM</span><span class="p">);</span>
<span class="linenos" data-linenos="2 "></span><span class="n">encCipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">ENCRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">secretKeySpec</span><span class="p">,</span><span class="w"> </span><span class="n">ivSpec</span><span class="p">);</span>
<span class="linenos" data-linenos="3 "></span>
<span class="linenos" data-linenos="4 "></span><span class="n">Cipher</span><span class="w"> </span><span class="n">decCipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getinstance</span><span class="p">(</span><span class="n">CIPHER_ALGORITHM</span><span class="p">);</span>
<span class="linenos" data-linenos="5 "></span><span class="n">decCipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">DECRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">secretKeySpec</span><span class="p">,</span><span class="w"> </span><span class="n">ivSpec</span><span class="p">);</span>
</code></pre></div>
<ul>
<li>
<p>This is the main section of our example. We use the derived key and IV, along with our specification of what encryption parameters we want to use, to form a Cipher object.</p>
</li>
<li>
<p>We actually create two, one in <strong>ENCRYPT_MODE</strong> and one in <strong>DECRYPT_MODE</strong>.</p>
</li>
<li>
<p>Once we have the cipher objects, we can perform encryption and decryption operations.</p>
</li>
<li>
<p>For encryption, we pass the string we want to encrypt (convert into a byte array) to the <strong>doFinal()</strong> method of the encrypting Cipher object. </p>
</li>
<li>
<p>The encryption operation is performed and the resulting encrypted bytes are returned to us.
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">encryptedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">encCipher</span><span class="p">.</span><span class="na">doFinal</span><span class="p">(</span><span class="n">clearText</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span>
</code></pre></div></p>
</li>
<li>
<p>We can also decrypt data using the same approach. In this case, we use the decrypting Cipher object, passing it the encrypted bytes and getting back to plaintext bytes.</p>
</li>
<li>
<p>As we started a string, we can reconstruct it, and the <strong>sameAsClearText</strong> string will contain exactly the same value as the <strong>clearText</strong> string.
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">decyptedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decCipher</span><span class="p">.</span><span class="na">doFinal</span><span class="p">(</span><span class="n">encryptedText</span><span class="p">);</span>
<span class="linenos" data-linenos="2 "></span><span class="n">String</span><span class="w"> </span><span class="n">sameAsClearText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">decryptedText</span><span class="p">);</span>
</code></pre></div></p>
</li>
</ul>
<hr />
<p>And that’s it. We now have a complete solution for protecting stored data, where we take a user-supplied password, derive a symmetric key from it, and encrypt and decrypt data at will, all in a few short lines of code.</p>
<p>Once we encrypt the data, we can store it in a file, in a database, or wherever. As long as we keep the symmetric key from compromise, an attacker will not be able to recover the data from its encrypted form.</p>
<h2 id="7-implement-logging-and-intrusion-detection">7. Implement Logging and Intrusion Detection<a class="headerlink" href="#7-implement-logging-and-intrusion-detection" title="Permanent link">#</a></h2>
<h3 id="tamper-detection">Tamper Detection<a class="headerlink" href="#tamper-detection" title="Permanent link">#</a></h3>
<p>Tamper or Intrusion detection is the ability of an application to sense that an active attempt to compromise the application’s integrity or the data associated with the application is in progress; the detection of the threat may enable the application to initiate appropriate defensive actions.</p>
<h3 id="responding-to-tamper-detection">Responding to Tamper Detection<a class="headerlink" href="#responding-to-tamper-detection" title="Permanent link">#</a></h3>
<ul>
<li>
<p>The obvious and simple solution would be to check for tampering on startup, and if detected, exit the app optionally with a message to the user explaining why.</p>
</li>
<li>
<p>Here look at different checks that may indicate a tampered, compromised, or hostile environment. </p>
</li>
<li>
<p>These are designed to be activated once you are ready for release.</p>
</li>
</ul>
<h4 id="detect-if-google-play-store-was-the-installer">Detect if Google Play store was the installer<a class="headerlink" href="#detect-if-google-play-store-was-the-installer" title="Permanent link">#</a></h4>
<ul>
<li>
<p>Detecting if the installer was the Google Play store is a simple check that the package name of the installer app matches that of the Google Play store. </p>
</li>
<li>
<p>Specifically, it checks if the installer package starts with <mark><strong>com.google.android</strong></mark>.</p>
</li>
<li>
<p>It is a useful check if you are distributed solely through the Google store.</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">checkGooglePlayStore</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="2 "></span><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">installerPackageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">().</span><span class="na">getInstallerPackageName</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">());</span>
<span class="linenos" data-linenos="3 "></span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">installerPackageName</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">installerPackageName</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&quot;com.google.android&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="4 "></span><span class="p">}</span>
</code></pre></div>
<h4 id="detect-if-it-runs-on-an-emulator">Detect if it runs on an Emulator<a class="headerlink" href="#detect-if-it-runs-on-an-emulator" title="Permanent link">#</a></h4>
<ul>
<li>
<p>The Java Reflection API makes it possible to inspect classes, methods, and fields at runtime; and in this case, allows us to override the access modifiers that would prevent ordinary code from compiling. </p>
</li>
<li>
<p>The emulator check uses reflection to access a hidden system class, android.os.SystemProperties. </p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isEmulator</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">            </span><span class="n">Class</span><span class="w"> </span><span class="n">systemPropertyClazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&quot;android.os.SystemProperties&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">kernelQemu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getProperty</span><span class="p">(</span><span class="n">systemPropertyClazz</span><span class="p">,</span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">                    </span><span class="s">&quot;ro.kernel.qemu&quot;</span><span class="p">).</span><span class="na">length</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">hardwareGoldfish</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getProperty</span><span class="p">(</span><span class="n">systemPropertyClazz</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">                    </span><span class="s">&quot;ro.hardware&quot;</span><span class="p">).</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;goldfish&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">modelSdk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getProperty</span><span class="p">(</span><span class="n">systemPropertyClazz</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">                    </span><span class="s">&quot;ro.product.model&quot;</span><span class="p">).</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;sdk&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="10 "></span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kernelQemu</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">hardwareGoldfish</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">modelSdk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="11 "></span><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="linenos" data-linenos="12 "></span><span class="w">            </span><span class="p">}</span>
<span class="linenos" data-linenos="13 "></span><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="14 "></span><span class="w">            </span><span class="c1">// error assumes emulator</span>
<span class="linenos" data-linenos="15 "></span><span class="w">        </span><span class="p">}</span>
<span class="linenos" data-linenos="16 "></span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="linenos" data-linenos="17 "></span><span class="p">}</span>
<span class="linenos" data-linenos="18 "></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getProperty</span><span class="p">(</span><span class="n">Class</span><span class="w"> </span><span class="n">clazz</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">propertyName</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="19 "></span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&quot;get&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="w"> </span><span class="p">})</span>
<span class="linenos" data-linenos="20 "></span><span class="w">            </span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">propertyName</span><span class="w"> </span><span class="p">});</span>
<span class="linenos" data-linenos="21 "></span><span class="p">}</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title"> </p>
<p>Using hidden APIs can be risky as they can change between Android versions.</p>
</div>
<h4 id="detect-if-it-runs-on-a-rooted-device">Detect if it runs on a Rooted Device<a class="headerlink" href="#detect-if-it-runs-on-a-rooted-device" title="Permanent link">#</a></h4>
<ul>
<li>
<p>Rooted devices may contain many apps that process sensitive information, such as banking apps, payment apps, social media, and cloud storage. </p>
</li>
<li>
<p>Malicious downloads can expose your device to hackers. </p>
</li>
<li>
<p>For these reasons, the apps installed on a device need to make sure that the device isn&rsquo;t rooted.</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">checkRoot</span><span class="p">(){</span>
<span class="linenos" data-linenos="2 "></span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">pathDir</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;PATH&quot;</span><span class="p">).</span><span class="na">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)){</span>
<span class="linenos" data-linenos="3 "></span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">pathDir</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;su&quot;</span><span class="p">).</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="4 "></span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="linenos" data-linenos="5 "></span><span class="w">        </span><span class="p">}</span>
<span class="linenos" data-linenos="6 "></span><span class="w">    </span><span class="p">}</span>
<span class="linenos" data-linenos="7 "></span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="linenos" data-linenos="8 "></span><span class="p">}</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title"> </p>
<p>Use <a href="https://github.com/scottyab/rootbeer">Rootbeer</a>. A simple to use root checking Android library.</p>
</div>
<h4 id="detect-if-the-app-has-the-debuggable-flag-enabled">Detect if the app has the “debuggable” flag enabled<a class="headerlink" href="#detect-if-the-app-has-the-debuggable-flag-enabled" title="Permanent link">#</a></h4>
<p>(something that should only be enabled during development)</p>
<ul>
<li>
<p>When debuggable is enabled, it is possible to connect via the Android Debug Bridge and perform detailed dynamic analysis. </p>
</li>
<li>
<p>The debuggable variable is a simple property of the <strong>&lt;application&gt;</strong> element in the <strong>AndroidManifest.xml</strong> file. </p>
</li>
<li>
<p>It is perhaps one of the easiest and most targeted properties to alter in order to perform dynamic analysis.</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isDebuggable</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="2 "></span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="na">getApplicationInfo</span><span class="p">().</span><span class="na">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ApplicationInfo</span><span class="p">.</span><span class="na">FLAG_DEBUGGABLE</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos" data-linenos="3 "></span><span class="p">}</span>
</code></pre></div>
<h4 id="application-signature-verification">Application Signature Verification<a class="headerlink" href="#application-signature-verification" title="Permanent link">#</a></h4>
<ul>
<li>
<p>Part of the process of an attacker modifying your application&rsquo;s .apk file breaks the digital signature.</p>
</li>
<li>
<p>This means that, if they want to install the .apk file on an Android device, it will need to be resigned using a different signing key.</p>
</li>
<li>
<p>Fortunately, at runtime, Android apps can query PackageManager to find app signatures.</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="c1">// CERTIFICATE&#39;S SHA1 Signature</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">CERTIFICATE</span><span class="w"> </span><span class="n">SHA1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;71920AC9486E087DCBCF5C7F6FEC952135858CC5&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">validateAppSignature</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">        </span><span class="c1">// get the signature form the package manager</span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">        </span><span class="n">Packageinfo</span><span class="w"> </span><span class="n">packageInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">().</span><span class="na">getPackageInfo</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">(),</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">GET_SIGNATURES</span><span class="p">);</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">        </span><span class="n">Signature</span><span class="o">[]</span><span class="w"> </span><span class="n">appSignatures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">.</span><span class="na">signatures</span><span class="p">;</span>
<span class="linenos" data-linenos="10 "></span>
<span class="linenos" data-linenos="11 "></span><span class="w">        </span><span class="c1">//this sample only checks the first certificate</span>
<span class="linenos" data-linenos="12 "></span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Signature</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">appSignatures</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="13 "></span><span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">signatureBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">signature</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">();</span>
<span class="linenos" data-linenos="14 "></span><span class="w">            </span><span class="c1">//calc shal in hex</span>
<span class="linenos" data-linenos="15 "></span><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">currentSignature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calcSHA1</span><span class="p">(</span><span class="n">signatureBytes</span><span class="p">);</span>
<span class="linenos" data-linenos="16 "></span><span class="w">            </span><span class="c1">//compare signatures</span>
<span class="linenos" data-linenos="17 "></span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">CERTIFICATE</span><span class="w"> </span><span class="n">SHA1</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">{</span><span class="n">currentSignature</span><span class="p">);</span>
<span class="linenos" data-linenos="18 "></span><span class="w">        </span><span class="p">}</span>
<span class="linenos" data-linenos="19 "></span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="20 "></span><span class="w">    </span><span class="c1">// if error assume failed to validate</span>
<span class="linenos" data-linenos="21 "></span><span class="w">    </span><span class="p">}</span>
<span class="linenos" data-linenos="22 "></span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="linenos" data-linenos="23 "></span><span class="p">}</span>
<span class="linenos" data-linenos="24 "></span>
<span class="linenos" data-linenos="25 "></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">calcSHA1</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">signature</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">NoSuchAlgorithmException</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="26 "></span><span class="w">    </span><span class="n">MessageDigest</span><span class="w"> </span><span class="n">digest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageDigest</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;SHA1&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="27 "></span><span class="w">    </span><span class="n">digest</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">signature</span><span class="p">);</span>
<span class="linenos" data-linenos="28 "></span><span class="w">    </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">signatureHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">digest</span><span class="p">.</span><span class="na">digest</span><span class="p">();</span>
<span class="linenos" data-linenos="29 "></span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bytesToHex</span><span class="p">(</span><span class="n">signatureHash</span><span class="p">);</span>
<span class="linenos" data-linenos="30 "></span><span class="p">}</span>
<span class="linenos" data-linenos="31 "></span>
<span class="linenos" data-linenos="32 "></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">bytesToHex</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="33 "></span><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">char</span><span class="o">[]</span><span class="w"> </span><span class="n">hexArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="sc">&#39;0&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;2&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;4&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;5&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;6&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="34 "></span><span class="w">            </span><span class="sc">&#39;7&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;8&#39;</span><span class="p">,</span><span class="sc">&#39;9&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;B&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;C&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;D&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;E&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;F&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="linenos" data-linenos="35 "></span><span class="w">    </span><span class="kt">char</span><span class="o">[]</span><span class="w"> </span><span class="n">hexChars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="o">[</span><span class="n">bytes</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="o">]</span><span class="p">;</span>
<span class="linenos" data-linenos="36 "></span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="linenos" data-linenos="37 "></span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bytes</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="38 "></span><span class="w">        </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bytes</span><span class="o">[</span><span class="n">j</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">;</span>
<span class="linenos" data-linenos="39 "></span><span class="w">        </span><span class="n">hexChars</span><span class="o">[</span><span class="n">j</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hexArray</span><span class="o">[</span><span class="n">v</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="o">]</span><span class="p">;</span>
<span class="linenos" data-linenos="40 "></span><span class="w">        </span><span class="n">hexChars</span><span class="o">[</span><span class="n">j</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hexArray</span><span class="o">[</span><span class="n">v</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0F</span><span class="o">]</span><span class="p">;</span>
<span class="linenos" data-linenos="41 "></span><span class="w">    </span><span class="p">}</span>
<span class="linenos" data-linenos="42 "></span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">hexChars</span><span class="p">);</span>
<span class="linenos" data-linenos="43 "></span><span class="p">}</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title"> </p>
<p>The hash values should not be hardcoded in real world and instead should be retrieved from a server.</p>
</div>
<h4 id="outputting-log-to-logcat">Outputting Log to LogCat<a class="headerlink" href="#outputting-log-to-logcat" title="Permanent link">#</a></h4>
<ul>
<li>
<p>There’s a logging mechanism called <strong>LogCat</strong> in Android, and not only system log information but also application log information outputs to the Logcat.</p>
</li>
<li>
<p>Log information in LogCat can be read out from other application in the same device.</p>
</li>
<li>
<p>So the application which outputs sensitive information to LogCat, is considered that it has the vulnerability of the information leakage.</p>
</li>
<li>
<p>From a security point of view, in release version application, it’s preferable that any log should not be output.</p>
</li>
</ul>
<p>Here we look for some ways to output messages to LogCat in a safe manner even in a release version application.</p>
<ul>
<li><strong>ProGuard</strong> - the method to control the Log output in release version application.
  ProGuard is one of the optimization tools which automatically delete the unnecessary code like unused methods, etc.</li>
</ul>
<p>Essentially there are <code>5</code> types of Log output methods:</p>
<table>
<thead>
<tr>
<th align="left">Log Type</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Log.e()</td>
<td align="left">ERROR</td>
</tr>
<tr>
<td align="left">Log.w()</td>
<td align="left">WARN</td>
</tr>
<tr>
<td align="left">Log.i()</td>
<td align="left">INFO</td>
</tr>
<tr>
<td align="left">Log.d()</td>
<td align="left">DEBUG</td>
</tr>
<tr>
<td align="left">Log.v()</td>
<td align="left">VERBOSE</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>It’s recommended to use the following methods for outputting operation log information:</p>
<ul>
<li>Log.e()           //ERROR</li>
<li>Log.w()           //WARN</li>
<li>Log.i()           //INFO  </li>
</ul>
</li>
<li>
<p>And the following for outputting development log information:</p>
<ul>
<li>Log.d()           //DEBUG</li>
<li>Log.v()           //VERBOSE</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="c1">//Sensitive information must not be output by</span>
<span class="linenos" data-linenos=" 2 "></span><span class="c1">// Log.e(D/w()/i()</span>
<span class="linenos" data-linenos=" 3 "></span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Not sensitive information (ERROR)&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">Log</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Not sensitive information (WARN)&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 5 "></span><span class="n">Log</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Not sensitive information (INFO)&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span><span class="c1">//Sensitive information should be output by</span>
<span class="linenos" data-linenos=" 8 "></span><span class="c1">// Log.d()/v() in case of need.</span>
<span class="linenos" data-linenos=" 9 "></span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sensitive information (DEBUG)&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="10 "></span><span class="n">Log</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">LOG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sensitive information (VERBOSE)&quot;</span><span class="p">);</span>
</code></pre></div>
<ul>
<li>
<p>If the application is for release, those two methods would be deleted automatically. </p>
</li>
<li>
<p>ProGuard is used to automatically delete code blocks where <strong>Log.d()</strong> and <strong>Log.v()</strong> is called.
<div class="highlight"><span class="filename">proguard-project.txt</span><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="o">-</span><span class="n">assumenosideeffects</span><span class="w"> </span><span class="kd">class</span> <span class="nc">android</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">log</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="2 "></span><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">sxx</span><span class="w"> </span><span class="nf">d</span><span class="p">(...);</span>
<span class="linenos" data-linenos="3 "></span><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">sxx</span><span class="w"> </span><span class="nf">v</span><span class="p">(...);</span>
<span class="linenos" data-linenos="4 "></span><span class="p">}</span>
</code></pre></div>
By specifying <strong>Log.d()</strong> and <strong>Log.v()</strong> as parameter of <code>-assumenosideeffects</code> option, call for Log.d() and Log.v() are granted as unnecessary code, and those are to be deleted.</p>
</li>
</ul>
<p>
<figure><img src="2_logcat_output.png" /><figcaption>Difference of LogCat output between development version application and release version application.</figcaption>
</figure>
</p>
<h2 id="8-leverage-security-frameworks-and-libraries">8. Leverage Security Frameworks and Libraries<a class="headerlink" href="#8-leverage-security-frameworks-and-libraries" title="Permanent link">#</a></h2>
<h4 id="securing-sharedpreferences-data-with-encrypted-sharedpreferences">Securing SharedPreferences data with Encrypted SharedPreferences<a class="headerlink" href="#securing-sharedpreferences-data-with-encrypted-sharedpreferences" title="Permanent link">#</a></h4>
<p>Android provides a simple framework for app developers to persistently store key-value pairs of primitive data types.</p>
<p>Thanks to the <strong>AndroidX Security Library</strong> which was recently added.</p>
<p>It is a library that wraps the default Android SharedPreferences to encrypt the key-value pairs for protecting them against attackers.</p>
<ol>
<li>
<p>Simply just create or fetch a Master Key from the Android Keystore:
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">MasterKey</span><span class="w"> </span><span class="n">masterKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MasterKey</span><span class="p">.</span><span class="na">Builder</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">MasterKey</span><span class="p">.</span><span class="na">DEFAULT_MASTER_KEY_ALIAS</span><span class="p">)</span>
<span class="linenos" data-linenos="2 "></span><span class="w">                    </span><span class="p">.</span><span class="na">setKeyScheme</span><span class="p">(</span><span class="n">MasterKey</span><span class="p">.</span><span class="na">KeyScheme</span><span class="p">.</span><span class="na">AES256_GCM</span><span class="p">)</span>
<span class="linenos" data-linenos="3 "></span><span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</code></pre></div>
We’re given a default key generation specification, AES256_GCM, to use for creating the master key and is recommended to use this specification.</p>
</li>
<li>
<p>Now create an instance of <strong>EncryptedSharedPreferences</strong> which is a wrapper around SharedPreferences and handles all of the encryption.
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">SharedPreferences</span><span class="w"> </span><span class="n">sharedPreferences</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EncryptedSharedPreferences</span><span class="p">.</span><span class="na">create</span><span class="p">(</span>
<span class="linenos" data-linenos="2 "></span><span class="w">                    </span><span class="n">context</span><span class="p">,</span>
<span class="linenos" data-linenos="3 "></span><span class="w">                    </span><span class="s">&quot;my_secure_preferences&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="4 "></span><span class="w">                    </span><span class="n">masterKey</span><span class="p">,</span>
<span class="linenos" data-linenos="5 "></span><span class="w">                    </span><span class="n">EncryptedSharedPreferences</span><span class="p">.</span><span class="na">PrefKeyEncryptionScheme</span><span class="p">.</span><span class="na">AES256_SIV</span><span class="p">,</span>
<span class="linenos" data-linenos="6 "></span><span class="w">                    </span><span class="n">EncryptedSharedPreferences</span><span class="p">.</span><span class="na">PrefValueEncryptionScheme</span><span class="p">.</span><span class="na">AES256_GCM</span><span class="p">);</span>
</code></pre></div>
Here <code>"my_secure_preferences"</code> is the name of the file in which the preferences will be saved.</p>
</li>
<li>
<p>Once we’ve created our <strong>EncryptedSharedPreferences</strong> instance, we can use it just like SharedPreferences to store and read values.
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="c1">//Storing a value</span>
<span class="linenos" data-linenos="2 "></span><span class="n">sharedPreferences</span><span class="p">.</span><span class="na">edit</span><span class="p">()</span>
<span class="linenos" data-linenos="3 "></span><span class="w">    </span><span class="p">.</span><span class="na">putString</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>
<span class="linenos" data-linenos="4 "></span><span class="w">    </span><span class="p">.</span><span class="na">apply</span><span class="p">()</span>
<span class="linenos" data-linenos="5 "></span>
<span class="linenos" data-linenos="6 "></span><span class="c1">//Reading a value</span>
<span class="linenos" data-linenos="7 "></span><span class="n">sharedPreferences</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;defaultValue&quot;</span><span class="p">);</span>
</code></pre></div></p>
</li>
</ol>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Standard SharedPreferences file</label><label for="__tabbed_1_2">Encrypted SharedPreferences file</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="n">xml</span><span class="w"> </span><span class="n">version</span><span class="o">=</span><span class="err">&#39;</span><span class="mf">1.0</span><span class="err">&#39;</span><span class="w"> </span><span class="n">encoding</span><span class="o">=</span><span class="err">&#39;</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">&#39;</span><span class="w"> </span><span class="n">standalone</span><span class="o">=</span><span class="err">&#39;</span><span class="n">yes</span><span class="err">&#39;</span><span class="w"> </span><span class="o">?&gt;</span>
<span class="o">&lt;</span><span class="n">map</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="kt">int</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;timeout &quot;</span><span class="w"> </span><span class="n">value</span><span class="o">=</span><span class="s">&quot;500&quot;</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="kt">boolean</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;is logged in&quot;</span><span class="w"> </span><span class="n">value</span><span class="o">=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;title&quot;</span><span class="o">&gt;</span><span class="n">secure</span><span class="w"> </span><span class="n">coding</span><span class="w"> </span><span class="n">practices</span><span class="o">&lt;/</span><span class="n">string</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">map</span><span class="o">&gt;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="n">xml</span><span class="w"> </span><span class="n">version</span><span class="o">=</span><span class="err">&#39;</span><span class="mf">1.0</span><span class="err">&#39;</span><span class="w"> </span><span class="n">encoding</span><span class="o">=</span><span class="err">&#39;</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">&#39;</span><span class="w"> </span><span class="n">standalone</span><span class="o">=</span><span class="err">&#39;</span><span class="n">yes</span><span class="err">&#39;</span><span class="w"> </span><span class="o">?&gt;</span>
<span class="o">&lt;</span><span class="n">map</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;MIIEpQIBAAKCAQEAYyb6BkBms39I7imXMOOUW1EDJIsbGNs&quot;</span><span class="o">&gt;</span>
<span class="w">        </span><span class="n">HhiXTk3JRgAMuKOwosHLLfaVvRUUT3ICK</span>
<span class="w">    </span><span class="o">&lt;/</span><span class="n">string</span><span class="o">&gt;</span>

<span class="w">    </span><span class="o">&lt;</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;TuwbBUOIrAylL9znGBJI87uEi7pWOFwYwX8SZi11KnD2VZ7&quot;</span><span class="o">&gt;</span>
<span class="w">        </span><span class="n">va617hf5imdM</span><span class="o">+</span><span class="n">P3KA3Ik50ZwFj1</span><span class="o">/</span><span class="n">Ed2</span>
<span class="w">    </span><span class="o">&lt;/</span><span class="n">string</span><span class="o">&gt;</span>

<span class="w">    </span><span class="o">&lt;</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;81qCOgn73Uo84Rjk73t1fVNYsPshl119ztma7U&quot;</span><span class="o">&gt;</span>
<span class="w">        </span><span class="n">tEcsr41t50rGWT9</span><span class="o">/</span><span class="n">pqlrMC5x503cc</span>
<span class="w">    </span><span class="o">&lt;/</span><span class="n">string</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">map</span><span class="o">&gt;</span>
</code></pre></div>
</div>
</div>
</div>
<h4 id="encrypting-a-database-with-sqlcipher">Encrypting a database with SQLCipher<a class="headerlink" href="#encrypting-a-database-with-sqlcipher" title="Permanent link">#</a></h4>
<p>SQLCipher is one of the simplest ways to enable secure storage in an Android app, and it&rsquo;s compatible for devices running Android 2.1+.</p>
<p>SQLCipher uses <strong>256-bit AES in CBC mode</strong> to encrypt each database page; in addition, each page has its own random initialization vector to further increase security.</p>
<p>SQLCipher is a separate implementation of the SQLite database, and rather than implementing its own encryption, it uses the widely used and tested <strong>OpenSSL libcrypto</strong> library.</p>
<ol>
<li>
<p>There are several ways to handle SQLite database, either by working directly with the SQLiteDatabase object or using SQLiteOpenHelper. 
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.database.sqlite.*</span><span class="p">;</span><span class="w">   </span><span class="c1">// Don&#39;t use this</span>
<span class="linenos" data-linenos="2 "></span><span class="kn">import</span><span class="w"> </span><span class="nn">net.sqlcipher.database.*</span><span class="p">;</span><span class="w">    </span><span class="c1">// Use this instead</span>
</code></pre></div>
But generally, if you are already using an SQLite database in your app, simply replace the <mark>import android.database.sqlite.*</mark> statement with <strong><mark>import net.sqlcipher.database.*</mark></strong></p>
</li>
<li>
<p>The simplest way to create an encrypted SQLCipher database is to call <strong>openOrCreateDatabase(…)</strong> with a <code>password</code>:
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">DB_VERSION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos" data-linenos="2 "></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">DB_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;my_encrypted_data.db&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="3 "></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;some-password&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="4 "></span>
<span class="linenos" data-linenos="5 "></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initDB</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="6 "></span><span class="w">    </span><span class="n">SQLiteDatabase</span><span class="p">.</span><span class="na">loadLibs</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
<span class="linenos" data-linenos="7 "></span><span class="w">    </span><span class="n">SQLiteDatabase</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SQLiteDatabase</span><span class="p">.</span><span class="na">openOrCreateDatabase</span><span class="p">(</span><span class="n">DB_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="linenos" data-linenos="8 "></span><span class="w">    </span><span class="n">database</span><span class="p">.</span><span class="na">execSQL</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;create table MyTable(a, b)&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="9 "></span><span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<p>Rest other operations remain exactly same as that of a normal SQLite database.</p>
<h4 id="android-keystore-provider">Android KeyStore Provider<a class="headerlink" href="#android-keystore-provider" title="Permanent link">#</a></h4>
<p>In Android 4.3, a new facility was added to allow apps to save private encryption keys in a system keystore called <strong>Android KeyStore</strong> which restricts access only to the app that created them and it was secured using the device pin code.</p>
<p>Specifically, the Android KeyStore is a certificate store, and so only public/private keys can be stored.</p>
<ol>
<li>
<p>Create a handle on your app’s KeyStore:
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ANDROID_KEYSTORE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;AndroidKeyStore&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">loadKeyStore</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">        </span><span class="n">keyStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyStore</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">ANDROID_KEYSTORE</span><span class="p">);</span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">        </span><span class="n">keyStore</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">        </span><span class="c1">// TODO: Handle this appropriately in your app</span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">        </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="p">}</span>
<span class="linenos" data-linenos="11 "></span><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>Generate and save the app’s key pair:
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">generateNewKeyPair</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">alias</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">    </span><span class="n">Calendar</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Calendar</span><span class="p">.</span><span class="na">getInstance</span><span class="p">();</span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="n">Calendar</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Calendar</span><span class="p">.</span><span class="na">getInstance</span><span class="p">();</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="n">end</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Calendar</span><span class="p">.</span><span class="na">YEAR</span><span class="p">);</span><span class="w">  </span><span class="c1">// expires 1 year from today</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="n">KeyPairGeneratorSpec</span><span class="w"> </span><span class="n">spec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">KeyPairGeneratorSpec</span><span class="p">.</span><span class="na">Builder</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">                                    </span><span class="p">.</span><span class="na">setAlias</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">                                    </span><span class="p">.</span><span class="na">setSubject</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">X500Principal</span><span class="p">(</span><span class="s">&quot;CN=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">alias</span><span class="p">))</span>
<span class="linenos" data-linenos="10 "></span><span class="w">                                    </span><span class="p">.</span><span class="na">setSerialNumber</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">.</span><span class="w"> </span><span class="n">TEN</span><span class="p">)</span>
<span class="linenos" data-linenos="11 "></span><span class="w">                                    </span><span class="p">.</span><span class="na">setStartDate</span><span class="p">(</span><span class="n">start</span><span class="p">.</span><span class="na">getTime</span><span class="p">())</span>
<span class="linenos" data-linenos="12 "></span><span class="w">                                    </span><span class="p">.</span><span class="na">setEndDate</span><span class="p">(</span><span class="n">end</span><span class="p">.</span><span class="na">getTime</span><span class="p">())</span>
<span class="linenos" data-linenos="13 "></span><span class="w">                                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="linenos" data-linenos="14 "></span>
<span class="linenos" data-linenos="15 "></span><span class="w">    </span><span class="c1">// use the Android keystore</span>
<span class="linenos" data-linenos="16 "></span><span class="w">    </span><span class="n">KeyPairGenerator</span><span class="w"> </span><span class="n">gen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyPairGenerator</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;RSA&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ANDROID_KEYSTORE</span><span class="p">);</span>
<span class="linenos" data-linenos="17 "></span><span class="w">    </span><span class="n">gen</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
<span class="linenos" data-linenos="18 "></span>
<span class="linenos" data-linenos="19 "></span><span class="w">    </span><span class="c1">// generates the keypair</span>
<span class="linenos" data-linenos="20 "></span><span class="w">    </span><span class="n">gen</span><span class="p">.</span><span class="na">generateKeyPair</span><span class="p">();</span>
<span class="linenos" data-linenos="21 "></span><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>Retrieve the key with a given alias: 
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kd">public</span><span class="w"> </span><span class="n">PrivateKey</span><span class="w"> </span><span class="nf">loadPrivateKey</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">alias</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">keyStore</span><span class="p">.</span><span class="na">isKeyEntry</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not find key alias: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">alias</span><span class="p">);</span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">    </span><span class="p">}</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="n">KeyStore</span><span class="p">.</span><span class="na">Entry</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyStore</span><span class="p">.</span><span class="na">getEntry</span><span class="p">(</span><span class="n">KEY_ALIAS</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">KeyStore</span><span class="p">.</span><span class="na">PrivateKeyEntry</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="10 "></span><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;alias: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">alias</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; is not a private key.&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="11 "></span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="linenos" data-linenos="12 "></span><span class="w">    </span><span class="p">}</span>
<span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="n">KeyStore</span><span class="p">.</span><span class="na">PrivateKeyEntry</span><span class="p">)</span><span class="w"> </span><span class="n">entry</span><span class="p">).</span><span class="na">getPrivateKey</span><span class="p">();</span>
<span class="linenos" data-linenos="15 "></span><span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<h4 id="generating-a-symmetric-encryption-key">Generating a Symmetric Encryption Key<a class="headerlink" href="#generating-a-symmetric-encryption-key" title="Permanent link">#</a></h4>
<p>A symmetric key describes a key that is used for both encryption and decryption. To create cryptographically secure encryption keys in general, we use securely generated pseudorandom numbers.</p>
<p>AES is the preferred encryption standard to DES, and typically used with key sizes 128 bit and 256 bit.</p>
<ol>
<li>
<p>Write the following function to generate a symmetric AES encrpytion key.
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">SecretKey</span><span class="w"> </span><span class="nf">generateAESKey</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">keySize</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">NoSuchAlgorithmException</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="2 "></span><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">SecureRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecureRandom</span><span class="p">();</span>
<span class="linenos" data-linenos="3 "></span><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">KeyGenerator</span><span class="w"> </span><span class="n">generator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyGenerator</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;AES&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="4 "></span><span class="w">    </span><span class="n">generator</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">keySize</span><span class="p">,</span><span class="w"> </span><span class="n">random</span><span class="p">);</span>
<span class="linenos" data-linenos="5 "></span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">generator</span><span class="p">.</span><span class="na">generateKey</span><span class="p">();</span>
<span class="linenos" data-linenos="6 "></span><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>Create a random 32-byte initialization vector (IV) that matches the AES key size of 256 bit.
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IvParameterSpec</span><span class="w"> </span><span class="n">iv</span><span class="p">;</span><span class="w"> </span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">IvParameterSpec</span><span class="w"> </span><span class="nf">getIV</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iv</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 5 "></span><span class="w">        </span><span class="kt">byte</span><span class="w"> </span><span class="o">[]</span><span class="w"> </span><span class="n">ivByteArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="mi">32</span><span class="o">]</span><span class="p">;</span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">        </span><span class="c1">//populate the array with random bytes</span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">        </span><span class="n">ivByteArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecureRandom</span><span class="p">().</span><span class="na">nextBytes</span><span class="p">(</span><span class="n">ivByteArray</span><span class="p">);</span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">        </span><span class="n">iv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IvParameterSpec</span><span class="p">(</span><span class="n">ivByteArray</span><span class="p">);</span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="p">}</span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">iv</span><span class="p">;</span>
<span class="linenos" data-linenos="11 "></span><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>Write the following function to encrypt an arbitrary string.
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">encrypt</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">plainText</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">GeneralSecurityException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 2 "></span><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Cipher</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;AES/CBC/PKCS5Padding&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="n">cipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">ENCRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">getKey</span><span class="p">(),</span><span class="w"> </span><span class="n">getIV</span><span class="p">());</span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cipher</span><span class="p">.</span><span class="na">doFinal</span><span class="p">(</span><span class="n">plainText</span><span class="p">.</span><span class="na">getBytes</span><span class="p">(</span><span class="s">&quot;UTF-8&quot;</span><span class="p">));</span>
<span class="linenos" data-linenos=" 5 "></span><span class="p">}</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">SecretKey</span><span class="w"> </span><span class="nf">getKey</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">NoSuchAlgorithmException</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">        </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generateAESKey</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="p">}</span><span class="w"> </span>
<span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<span class="linenos" data-linenos="12 "></span><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>For completeness, the preceding snippet shows how to decrypt.
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">decrypt</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">plainText</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">GeneralSecurityException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="2 "></span><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Cipher</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;AES/CBC/PKCS5Padding&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="3 "></span><span class="w">    </span><span class="n">cipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">DECRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">getKey</span><span class="p">(),</span><span class="w"> </span><span class="n">getIV</span><span class="p">());</span>
<span class="linenos" data-linenos="4 "></span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cipher</span><span class="p">.</span><span class="na">doFinal</span><span class="p">(</span><span class="n">cipherText</span><span class="p">).</span><span class="na">toString</span><span class="p">();</span>
<span class="linenos" data-linenos="5 "></span><span class="p">}</span>
</code></pre></div>
The only difference is that here we called the <strong>Cipher.init()</strong> method using the <code>Cipher.DECRYPT_MODE</code> constant.</p>
</li>
</ol>
<h2 id="9-monitor-error-and-exception-handling">9. Monitor Error and Exception Handling<a class="headerlink" href="#9-monitor-error-and-exception-handling" title="Permanent link">#</a></h2>
<p>Exceptions occur when an application gets into an abnormal or error state.</p>
<p><strong>Monitor Error and Exception Handling is about ensuring that the app will handle an exception and transition to a safe state without exposing sensitive information via the UI or the app&rsquo;s logging mechanisms.</strong></p>
<ul>
<li>
<p>Plan for standard <strong>Runtime Exceptions</strong> (e.g. <em>NullPointerException, IndexOutOfBoundsException, ActivityNotFoundException, CancellationException, SQLException</em>) by creating proper null checks, bound checks, and the like.</p>
</li>
<li>
<p>Make sure that all confidential information handled by high-risk applications is always wiped during execution of the finally blocks.
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">secret</span><span class="p">;</span>
<span class="linenos" data-linenos="2 "></span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="3 "></span><span class="w">    </span><span class="c1">//use secret</span>
<span class="linenos" data-linenos="4 "></span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SPECIFICEXCEPTIONCLASS</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SPECIFICEXCEPTIONCLASS2</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="5 "></span><span class="w">    </span><span class="c1">// handle any issues</span>
<span class="linenos" data-linenos="6 "></span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="7 "></span><span class="w">    </span><span class="c1">//clean the secret.</span>
<span class="linenos" data-linenos="8 "></span><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>Adding a general exception handler for uncaught exceptions is a best practice for resetting the application’s state when a crash is imminent:
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MemoryCleanerOnCrash</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="na">UncaughtExceptionHandler</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MemoryCleanerOnCrash</span><span class="w"> </span><span class="n">S_INSTANCE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MemoryCleanerOnCrash</span><span class="p">();</span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Thread</span><span class="p">.</span><span class="na">UncaughtExceptionHandler</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mHandlers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="c1">//initialize the handler and set it as the default exception handler</span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 8 "></span><span class="w">        </span><span class="n">S_INSTANCE</span><span class="p">.</span><span class="na">mHandlers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">getDefaultUncaughtExceptionHandler</span><span class="p">());</span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="na">setDefaultUncaughtExceptionHandler</span><span class="p">(</span><span class="n">S_INSTANCE</span><span class="p">);</span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="p">}</span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span><span class="w">    </span><span class="nd">@Override</span>
<span class="linenos" data-linenos="13 "></span><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">uncaughtException</span><span class="p">(</span><span class="n">Thread</span><span class="w"> </span><span class="n">thread</span><span class="p">,</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="14 "></span>
<span class="linenos" data-linenos="15 "></span><span class="w">        </span><span class="c1">//handle the cleanup here</span>
<span class="linenos" data-linenos="16 "></span><span class="w">        </span><span class="c1">//....</span>
<span class="linenos" data-linenos="17 "></span><span class="w">        </span><span class="c1">//and then show a message to the user if possible given the context</span>
<span class="linenos" data-linenos="18 "></span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">UncaughtExceptionHandler</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">mHandlers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="19 "></span><span class="w">            </span><span class="n">handler</span><span class="p">.</span><span class="na">uncaughtException</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">);</span>
<span class="linenos" data-linenos="20 "></span><span class="w">        </span><span class="p">}</span>
<span class="linenos" data-linenos="21 "></span><span class="w">    </span><span class="p">}</span>
<span class="linenos" data-linenos="22 "></span><span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>Now the handler’s initializer must be called in your custom Application class (e.g., the class that extends Application):
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nd">@Override</span>
<span class="linenos" data-linenos="2 "></span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">attachBaseContext</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">base</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="3 "></span><span class="w">    </span><span class="kd">super</span><span class="p">.</span><span class="na">attachBaseContext</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
<span class="linenos" data-linenos="4 "></span><span class="w">    </span><span class="n">MemoryCleanerOnCrash</span><span class="p">.</span><span class="na">init</span><span class="p">();</span>
<span class="linenos" data-linenos="5 "></span><span class="p">}</span>
</code></pre></div></p>
</li>
</ul>
<h2 id="10-handling-intents">10. Handling Intents<a class="headerlink" href="#10-handling-intents" title="Permanent link">#</a></h2>
<p>Using an untrusted intent to launch a component, for example, by calling <strong>startActivity();</strong> or to return data, for example, by calling <strong>setResult();</strong> is dangerous and can allow malicious  apps to cause the following problems:</p>
<ul>
<li>Steal sensitive files or system data (like SMS messages) from your app.</li>
<li>Launch your app’s private components with poisoned arguments.</li>
</ul>
<p>It is important that your app does not call <strong>startActivity</strong>, <strong>startService</strong>, <strong>sendBroadcast</strong>, or <strong>setResult</strong> on untrusted intents without validating or sanitizing these intents.</p>
<h3 id="intent-redirection">Intent Redirection<a class="headerlink" href="#intent-redirection" title="Permanent link">#</a></h3>
<ul>
<li>
<p>Some apps contain an Intent Redirection issue which can allow malicious apps to access private app components or files.</p>
</li>
<li>
<p>Intent Redirection occurs when an activity can forward intents to arbitrary components allowing them to reach even unintended private and sensitive ones. </p>
</li>
<li>
<p>Usually, the redirecting activity is intended to launch only a single or a predefined set of activities. </p>
</li>
<li>
<p>Limiting the components that can be reached only to those meant by the developer can eliminate the problem.</p>
</li>
<li>
<p>Generally you can put an Intent to an Intent with:
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">();</span>
<span class="linenos" data-linenos="2 "></span><span class="n">Intent</span><span class="p">.</span><span class="na">putExtra</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_INTENT</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">());</span>
</code></pre></div></p>
</li>
<li>
<p>To retrieve the Intent (from within an Activity) from the intent you can do the following:
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIntent</span><span class="p">().</span><span class="na">getParcelableExtra</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_INTENT</span><span class="p">);</span>
</code></pre></div></p>
</li>
</ul>
<h4 id="private-vs-public-components-can-make-the-difference">Private vs Public components can make the difference<a class="headerlink" href="#private-vs-public-components-can-make-the-difference" title="Permanent link">#</a></h4>
<p>If the app component does not need to receive intents from other apps then you can make that app component private by setting the <code>android:exported="false"</code> in your app’s <strong>AndroidManifest.xml</strong> file</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="o">&lt;[</span><span class="n">component</span><span class="o">-</span><span class="n">name</span><span class="o">]</span><span class="w"> </span><span class="n">android</span><span class="p">:</span><span class="n">exported</span><span class="o">=</span><span class="s">&quot;false&quot;</span><span class="o">&gt;</span>
<span class="linenos" data-linenos="2 "></span><span class="p">...</span>
<span class="linenos" data-linenos="3 "></span><span class="o">&lt;/[</span><span class="n">component</span><span class="o">-</span><span class="n">name</span><span class="o">]&gt;</span>
</code></pre></div>
<h4 id="validating-the-source-of-the-intent">Validating the source of the Intent<a class="headerlink" href="#validating-the-source-of-the-intent" title="Permanent link">#</a></h4>
<p>You can verify that the originating activity can be trusted using methods like <strong>getCallingActivity()</strong>.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="c1">//Check if the originating Activity is from trusted package</span>
<span class="linenos" data-linenos=" 2 "></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getCallingActivity</span><span class="p">().</span><span class="na">getPackageName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;desired_package&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="w">    </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIntent</span><span class="p">();</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="w">    </span><span class="c1">//extract the nested Intent</span>
<span class="linenos" data-linenos=" 7 "></span><span class="w">    </span><span class="n">Intent</span><span class="w"> </span><span class="n">forward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Intent</span><span class="p">)</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getParcelableExtra</span><span class="p">(</span><span class="s">&quot;extra_intent&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="w">    </span><span class="c1">//redirect the nested Intent</span>
<span class="linenos" data-linenos="10 "></span><span class="w">    </span><span class="n">startActivity</span><span class="p">(</span><span class="n">forward</span><span class="p">);</span>
<span class="linenos" data-linenos="11 "></span><span class="p">}</span>
</code></pre></div>
<h4 id="make-sure-that-embedded-intent-is-not-harmful">Make sure that embedded intent is not harmful<a class="headerlink" href="#make-sure-that-embedded-intent-is-not-harmful" title="Permanent link">#</a></h4>
<p>You should verify that the redirected intent:</p>
<ul>
<li>will not be sent to any of your app’s private components, and</li>
<li>will not be sent to an external app’s components.</li>
</ul>
<p>Apps can check which component will be used to handle the intent before redirecting it using methods like <strong>resolveActivity()</strong>.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIntent</span><span class="p">();</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="c1">//extract the nested Intent</span>
<span class="linenos" data-linenos=" 4 "></span><span class="n">Intent</span><span class="w"> </span><span class="n">forward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Intent</span><span class="p">)</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getParcelableExtra</span><span class="p">(</span><span class="s">&quot;extra_intent&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="c1">//get component name</span>
<span class="linenos" data-linenos=" 7 "></span><span class="n">ComponentName</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">forward</span><span class="p">.</span><span class="na">resolveActivity</span><span class="p">(</span><span class="n">getPackageManager</span><span class="p">());</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="c1">//Check that the package name and class name are as intended</span>
<span class="linenos" data-linenos="10 "></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;desired_package&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="na">getClassName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;desired_class&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="11 "></span><span class="w">    </span><span class="c1">//redirect the nested Intent</span>
<span class="linenos" data-linenos="12 "></span><span class="w">    </span><span class="n">startActivity</span><span class="p">(</span><span class="n">forward</span><span class="p">);</span>
<span class="linenos" data-linenos="13 "></span><span class="p">}</span>
</code></pre></div>



    
    <!-- Get setting from mkdocs.yml, but allow page-level overrides -->



<!-- Inject Disqus into current page -->

    <h2 id="__comments">Comments</h2>
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = "https://bhardwajabhi.github.io/MyBlogs/posts/mobile-security/android-secure-coding-practices/"
            this.page.identifier =
                "posts/mobile-security/android-secure-coding-practices/"
        }

        /* Set up for the first time */
        if (typeof DISQUS === "undefined") {
            var script = document.createElement("script")
            script.async = true
            script.src = "https://bhardwajAbhi.github.io.disqus.com/embed.js"
            script.setAttribute("data-timestamp", Date.now())

            /* Inject script tag */
            document.body.appendChild(script)

        /* Set up on navigation (instant loading) */
        } else {
            DISQUS.reset({
                reload: true,
                config: disqus_config
            })
        }
    </script>



              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2023 Abhishek Bhardwaj </br> <a href="https://github.com/vuquangtrong/mkdocs-material-blog">Blog Theme</a> / <a href="https://squidfunk.github.io/mkdocs-material/">Material for MkDocs</a>

    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/bhardwajAbhi" target="_blank" rel="noopener" title="Abhishek" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://facebook.com/_AbhiBhardwaj" target="_blank" rel="noopener" title="Abhishek" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.linkedin.com/in/bhardwaj-abhi" target="_blank" rel="noopener" title="Abhishek" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.indexes", "navigation.top", "content.code.copy", "search.suggest", "search.highlight", "search.share", "content.code.annotate", "content.tabs.link"], "search": "../../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.220ee61c.min.js"></script>
      
        
          <script src="../../../assets/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
        
          <script src="../../../assets/view-bigimg.js"></script>
        
      
        
          <script src="../../../assets/extra.js"></script>
        
      
    
  </body>
</html>